<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Prenota - Coworking Mio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-5">
        <h1>Debug Pagina Prenota</h1>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4>Console Debug</h4>
                    </div>
                    <div class="card-body">
                        <div id="debugConsole" class="bg-dark text-light p-3"
                            style="height: 400px; overflow-y: auto; font-family: monospace;">
                            Inizializzazione debug...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Funzioni</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testFunctions()">Test Funzioni</button>
                        <button class="btn btn-success" onclick="testConfig()">Test Config</button>
                        <button class="btn btn-warning" onclick="testAPI()">Test API</button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Stato Variabili</h5>
                    </div>
                    <div class="card-body">
                        <div id="variableStatus"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/prenota.js"></script>

    <script>
        // Override console.log per catturare i messaggi
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addToDebug(message, type = 'log') {
            const debugConsole = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-light';

            debugConsole.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }

        console.log = function (...args) {
            originalLog.apply(console, args);
            addToDebug(args.join(' '), 'log');
        };

        console.error = function (...args) {
            originalError.apply(console, args);
            addToDebug(args.join(' '), 'error');
        };

        console.warn = function (...args) {
            originalWarn.apply(console, args);
            addToDebug(args.join(' '), 'warn');
        };

        // Test funzioni
        function testFunctions() {
            addToDebug('=== TEST FUNZIONI ===');

            const functions = [
                'checkDisponibilita',
                'validateDates',
                'updateNavigationButtons',
                'nextStep',
                'previousStep',
                'confermaPrenotazione',
                'logout',
                'onSedeChange',
                'onSpazioChange',
                'loadSpazi',
                'showStep',
                'setupEventHandlers',
                'setupAllEventHandlers',
                'showAlert'
            ];

            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    addToDebug(`✅ ${funcName}: OK`);
                } else {
                    addToDebug(`❌ ${funcName}: MANCANTE`);
                }
            });
        }

        // Test configurazione
        function testConfig() {
            addToDebug('=== TEST CONFIGURAZIONE ===');

            if (window.CONFIG) {
                addToDebug(`✅ CONFIG trovato`);
                addToDebug(`API_BASE: ${window.CONFIG.API_BASE || 'MANCANTE'}`);
                addToDebug(`HOSTNAME: ${window.CONFIG.HOSTNAME || 'MANCANTE'}`);
                addToDebug(`ENVIRONMENT: ${window.CONFIG.ENVIRONMENT || 'MANCANTE'}`);
            } else {
                addToDebug(`❌ CONFIG non trovato`);
            }

            if (typeof getAuthHeaders === 'function') {
                addToDebug(`✅ getAuthHeaders: OK`);
            } else {
                addToDebug(`❌ getAuthHeaders: MANCANTE`);
            }
        }

        // Test API
        function testAPI() {
            addToDebug('=== TEST API ===');

            if (window.CONFIG && window.CONFIG.API_BASE) {
                addToDebug(`Test chiamata API: ${window.CONFIG.API_BASE}/sedi`);

                $.ajax({
                    url: `${window.CONFIG.API_BASE}/sedi`,
                    method: 'GET',
                    timeout: 10000
                })
                    .done(function (response) {
                        addToDebug(`✅ API /sedi risponde: ${response.length} sedi trovate`);
                    })
                    .fail(function (xhr, status, error) {
                        addToDebug(`❌ API /sedi errore: ${status} - ${error}`);
                    });
            } else {
                addToDebug(`❌ API_BASE non configurato`);
            }
        }

        // Aggiorna stato variabili
        function updateVariableStatus() {
            const statusDiv = document.getElementById('variableStatus');

            let status = '';
            status += `<strong>currentStep:</strong> ${typeof currentStep !== 'undefined' ? currentStep : 'UNDEFINED'}<br>`;
            status += `<strong>selectedSede:</strong> ${typeof selectedSede !== 'undefined' ? selectedSede : 'UNDEFINED'}<br>`;
            status += `<strong>selectedSpazio:</strong> ${typeof selectedSpazio !== 'undefined' ? selectedSpazio : 'UNDEFINED'}<br>`;
            status += `<strong>disponibilitaVerificata:</strong> ${typeof disponibilitaVerificata !== 'undefined' ? disponibilitaVerificata : 'UNDEFINED'}<br>`;
            status += `<strong>jQuery:</strong> ${typeof $ !== 'undefined' ? 'OK' : 'MANCANTE'}<br>`;
            status += `<strong>jQuery versione:</strong> ${typeof $ !== 'undefined' ? $.fn.jquery : 'N/A'}<br>`;

            statusDiv.innerHTML = status;
        }

        // Aggiorna stato ogni secondo
        setInterval(updateVariableStatus, 1000);

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function () {
            addToDebug('=== PAGINA CARICATA ===');
            addToDebug('jQuery caricato: ' + (typeof $ !== 'undefined'));
            addToDebug('config.js caricato: ' + (typeof window.CONFIG !== 'undefined'));
            addToDebug('prenota.js caricato: ' + (typeof checkDisponibilita !== 'undefined'));

            // Test automatico dopo 2 secondi
            setTimeout(() => {
                testFunctions();
                testConfig();
            }, 2000);
        });
    </script>
</body>

</html>